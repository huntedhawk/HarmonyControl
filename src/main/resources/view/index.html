@import net.whistlingfish.harmony.config.Activity
@args Activity currentActivity, List activities
@extends(view.main.html, title: "Start")

@def boolean isCurrentActivity(Activity activity) {
    if(currentActivity != null && currentActivity.getId().equals(activity.getId())) {
        return true;
    }
    return false;
}

<script type="text/javascript">
    function activityClicked(obj) {
        $('.btn-primary').each(function () {
            $(this).removeClass('btn-primary lighten-2');
            $(this).addClass('btn-default');
        });
        $('.panel-primary').each(function () {
            $(this).removeClass('panel-primary');
            $(this).addClass('panel-default');
            $(this).addClass('hide');
        });
        $(obj).removeClass('btn-default');
        $(obj).addClass('btn-primary lighten-2');

        var activityId = obj.id.substring('btn_activity_'.length, obj.id.length);
        $(obj).toggleClass('active');
        callCommand(activityId, '{"command":"switch", "deviceId":"' + activityId + '"}');
    }

    function callCommand(activityId, command) {
        $.ajax({
            method: 'POST',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            url: 'command',
            data: command
        }).done(function (msg) {
            if (msg.status != 'OK') {
                alert('OOOPS State: ' + msg.status + ' Message: ' + msg.message);
            } else {
                if (msg.command == 'switch') {
                    $('.btn #active-icon').remove();
                    var activityBtn = $('#btn_activity_' + activityId);
                    activityBtn.toggleClass('active');
                    activityBtn.prepend('<i id="active-icon" class="mdi-av-play-arrow right"></i>');
                    if (activityId == -1) {
                        return;
                    }
                    var panel = $('#panel_activity_' + activityId);
                    panel.removeClass('hide');
                    panel.addClass('panel-primary');
                }
            }
        });
    }
</script>
<nav class="teal" role="navigation">
    <div class="nav-wrapper container">
        <a id="logo-container" class="brand-logo center">Harmony Web Control</a>
    </div>
</nav>
<div id="content" class="container">
    <div class="row center">
        @for(net.whistlingfish.harmony.config.Activity activity : activities) {
            <a id="btn_activity_@activity.getId()" class="wave-effect waves-light teal btn has-spinner
                    @{ if(isCurrentActivity(activity)){
                        pe(" btn-primary lighten-2");
                       } else {
                         pe(" btn-default");
                        }
                     }" onclick="activityClicked(this)">
                        <span class="spinner">
                            <i class="fa fa-refresh fa-spin"></i>
                        </span>
                        @if(isCurrentActivity(activity)) {
                            <i id="active-icon" class="mdi-av-play-arrow right"></i>
                        }
                        @activity.getLabel()
            </a>
        }
    </div>
    <div class="row center">
        @for(net.whistlingfish.harmony.config.Activity activity : activities) {
            @if(activity.getId() != -1) {
                <div id="panel_activity_@activity.getId()" class="@{ if(!isCurrentActivity(activity)){
                                                                                                pe("hide");
                                                                                             }else {
                                                                                                pe("panel-primary");
                                                                                             }
                                                                                            }">
                    <h4 class="header teal-text lighten-3">Controls</h4>
                        @if(activity.getControlGroup() != null) {
                        @for( net.whistlingfish.harmony.config.ControlGroup controlGroup : activity.getControlGroup()) {
                        <div class="card">
                            <h5 class="grey-text darken-2-5">@controlGroup.getName()</h5>
                                @for(net.whistlingfish.harmony.config.Function function : controlGroup.getFunction()) {
                                <div class="small-divider"></div>
                                <div class="section" style="padding-left: 10px;padding-right: 10px;">
                                    <a href="javascript:callCommand('@activity.getId()', '@function.getAction()')" class="waves-effect waves-light btn" style="display: block;">@function.getLabel()</a>
                                </div>
                                }
                        </div>
                        }
                        }
                </div>
            }
        }
    </div>
</div>